---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  "*-ks":
    desc: Render a Flux Kustomizations [DIR=required] [NAME] [SRC]
    vars:
      OPERATION: "{{index .MATCH 0}}"
      OPERATION_ARGS: |-
        {{if eq .OPERATION "apply"}} --server-side --field-manager=kustomize-controller{{end}}
      KS_DIR: "{{.K8S_DIR}}/apps/{{.DIR}}"
    requires:
      vars:
        - DIR
    preconditions:
      - '[[ "{{.OPERATION}}" == "build" || "{{.OPERATION}}" == "apply" || "{{.OPERATION}}" == "delete" ]]'
      - which kubectl flux-local
      - test -d {{.KS_DIR}}
    cmds:
      - flux-local build ks --all-namespaces {{.NS}} --path {{.KS_DIR}} {{.NAME}}
        | yq -
        {{ if or (eq .OPERATION "apply") (eq .OPERATION "delete") -}}
        | kubectl {{.OPERATION}} {{- .OPERATION_ARGS}} --filename -
        {{ end }}

  "*-ks-all":
    desc: Suspend or resume all Flux Kustomizations
    vars:
      STATE: '{{index .MATCH 0}}'
    preconditions:
      - '[[ "{{.STATE}}" == "suspend" || "{{.STATE}}" == "resume" ]]'
      - which flux kubectl
    cmds:
      - kubectl get ns -o jsonpath='{.items[*].metadata.name}' | xargs -n1 flux {{.STATE}} ks --all --namespace

  gr-sync:
    desc: Sync Flux GitRepositories
    cmds:
      - |
        kubectl get gitrepositories --context={{.cluster}} --all-namespaces --no-headers | awk '{print $1, $2}' \
          | xargs --max-procs=4 -l bash -c \
            'kubectl --context={{.cluster}} -n $0 annotate gitrepository/$1 reconcile.fluxcd.io/requestedAt=$(date +%s) --field-manager=flux-client-side-apply --overwrite'
    vars:
      cluster: '{{.cluster | default "main"}}'