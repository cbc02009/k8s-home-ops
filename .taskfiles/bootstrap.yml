---
version: "3"

tasks:

  cilium:
    desc: 2. Bootstrap cilium
    cmds:
      - kustomize build talos/cni --enable-helm | kubectl apply -f -

  csr-approver:
    desc: 1. Bootstrap the CSR Approver
    cmds:
      - kustomize build talos/kubelet-csr-approver --enable-helm | kubectl apply -f -

  sops:
    desc: 4. Bootstrap sops
    cmds:
      - cat ~/.config/sops/age/keys.txt | kubectl -n flux-system create secret generic sops-age --from-file=age.agekey=/dev/stdin

  github:
    desc: 5. decrypt and load github ssh key
    cmds:
      - sops --decrypt kubernetes/bootstrap/github-deploy-key.sops.yaml | kubectl apply -f -

  flux:
    desc: 3. Bootstrap flux (as per version in manifest)
    cmds:
      - kubectl apply -n flux-system --server-side --kustomize {{.CLUSTER_DIR}}/bootstrap/flux
      - kubectl apply -f {{.CLUSTER_DIR}}/flux/vars/cluster-settings.yaml
      - sops --decrypt {{.CLUSTER_DIR}}/flux/vars/cluster-secrets.sops.yaml | kubectl apply -f -

  cluster:
    desc: 7. Bootstrap Cluster
    cmds:
      - kubectl apply --server-side --kustomize kubernetes/flux/config/

  crds:
    desc: 6. Bootstrap CRDs
    cmds:
      - kubectl apply --server-side --kustomize {{.CLUSTER_DIR}}/bootstrap/crds/

  all:
    desc: run all bootstrap commands in order
    cmds:
      - go-task bootstrap:csr-approver
      - go-task bootstrap:cilium
      - go-task bootstrap:flux
      - go-task bootstrap:sops
      - go-task bootstrap:github
      - go-task bootstrap:crds
      - go-task bootstrap:cluster
