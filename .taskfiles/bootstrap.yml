---
version: "3"

vars:
  cniDir: "{{.PROJECT_DIR}}/infrastructure/talos/integrations/cni"
  csrDir: "{{.PROJECT_DIR}}/infrastructure/talos/integrations/kubelet-csr-approver"

tasks:

  cilium:
    desc: 2. Bootstrap cilium
    cmds:
      - rm -rf {{.cniDir}}/charts
      - echo "# This manifest was generated by automation. DO NOT EDIT." > {{.cniDir}}/cilium.yaml
      - kustomize build --enable-helm --load-restrictor=LoadRestrictionsNone {{.cniDir}} >> {{.cniDir}}/cilium.yaml
      - rm -rf {{.cniDir}}/charts
      - kubectl apply -f {{.cniDir}}/cilium.yaml

  csr-approver:
    desc: 1. Bootstrap the CSR Approver
    cmds: |
      rm -rf kubelet-csr-approver/charts
      envsubst < kubernetes/apps/system-controllers/kubelet-csr-approver/app/values.yaml > {{.csrDir}}/csr-approver/values.yaml
      if ! kubectl get ns system-controllers >/dev/null 2>&1; then
        kubectl create ns system-controllers
      fi
      kustomize build --enable-helm csr-approver | kubectl apply -f -
      rm kubelet-csr-approver/values.yaml
      rm -rf kubelet-csr-approver/charts

  doppler:
    desc: 4. Bootstrap Doppler
    cmds:
      - kubectl create secret generic  -n flux-system cluster-secrets --from-env-file <(doppler secrets download -p cluster -c prd --no-file --format docker)
      - kubectl create secret generic -n flux-system doppler-token-auth-api --from-literal dopplerToken=$(doppler secrets -p doppler -c prd get DOPPLER_PAT --plain)

  github:
    desc: 5. decrypt and load github ssh key
    cmds:
      - sops --decrypt kubernetes/bootstrap/github-deploy-key.sops.yaml | kubectl apply -f -

  flux:
    desc: 3. Bootstrap flux (as per version in manifest)
    cmds:
      - kubectl apply -n flux-system --server-side --kustomize {{.CLUSTER_DIR}}/bootstrap/flux
      - kubectl apply -f {{.CLUSTER_DIR}}/flux/vars/cluster-settings.yaml

  cluster:
    desc: 8. Bootstrap Cluster
    cmds:
      - kubectl apply --server-side --kustomize kubernetes/flux/config/

  crds:
    desc: 6. Bootstrap CRDs
    cmds:
      - kubectl apply --server-side --kustomize {{.CLUSTER_DIR}}/bootstrap/crds/

  rook:
    desc: 7. Wipe Rook
    cmds:
      - kubectl apply -f tools/wipe-rook.yaml

  all:
    desc: run all bootstrap commands in order
    cmds:
      - go-task bs:csr-approver
      - go-task bs:cilium
      - go-task bs:flux
      - go-task bs:doppler
      - go-task bs:github
      - go-task bs:crds
      - go-task bs:rook
      - go-task bs:cluster
