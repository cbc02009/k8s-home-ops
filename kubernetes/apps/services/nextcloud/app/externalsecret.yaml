---
# yaml-language-server: $schema=https://kubernetes-schemas.kokoro.wtf/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: nextcloud
  namespace: services
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: nextcloud-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Postgres Init
        POSTGRES_DB: "nextcloud"
        POSTGRES_HOST: ${POSTGRES_HOST}
        POSTGRES_SUPER_PASS: "{{ .pg_password }}"
        POSTGRESS_USER: "{{ .nc_pg_user }}"
        POSTGRESS_PASS: "{{ .nc_pg_pass }}"

        # Nextcloud
        ADMIN_USER: "{{ .nc_username }}"
        ADMIN_PASS: "{{ .nc_password }}"
        MINIO_ACCESS_KEY_ID: "{{ .minio_nextcloud_access_key }}"
        MINIO_SECRET_ACCESS_KEY: "{{ .minio_nextcloud_secret_key }}"
        NEXTCLOUD_CONFIGS: |
          s3.config.php: |-
            <?php
            $CONFIG = array (
              'objectstore' => array(
                'class' => '\\OC\\Files\\ObjectStore\\S3',
                'arguments' => array(
                  'hostname'   => '{{ .minio_host }}',
                  'port'       => 9000,
                  'bucket'     => 'nextcloud',
                  'autocreate' => true,
                  'key'        => '{{ .minio_nextcloud_access_key }}',
                  'secret'     => '{{ .minio_nextcloud_secret_key }}',
                  'region'     => 'optional',
                  'use_ssl'    => false,
                  'use_path_style'=> true
                ),
              ),
            );

          proxy.config.php: |-
            <?php
            $CONFIG = array (
              'trusted_proxies' =>
              array(
                0 => '10.0.0.0/8',
              ),
              'forwarded_for_headers' =>
              array (
                0 => 'HTTP_X_FORWARDED_FOR',
              ),
            );

  dataFrom:
    - extract:
        key: nextcloud
      rewrite:
        - regexp:
            source: "(.*)"
            target: "nc_$1"
    - extract:
        key: postgres
      rewrite:
        - regexp:
            source: "(.*)"
            target: "pg_$1"
    - extract:
        key: Minio
      rewrite:
        - regexp:
            source: "(.*)"
            target: "minio_$1"
