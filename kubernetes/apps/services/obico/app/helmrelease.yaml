---
# yaml-language-server: $schema=https://kubernetes-schemas.kokoro.wtf/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app obico
  namespace: services
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.3.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:

    image:
      repository: ghcr.io/gabe565/obico/web
      tag: latest@sha256:887b19305043d46694cb59271834b6469397db00e5b65687a94b6c00d291c9e6

    service:
      main:
        ports:
          http:
            port: 3334

    ingress:
      main:
        enabled: true
        ingressClassName: "nginx"
        annotations:
        hosts:
          - host: &host "{{ .Release.Name }}.${EXTERNAL_DOMAIN}"
            paths:
              - path: /
        tls:
          - hosts:
              - *host

    command: ["sh -c 'python manage.py migrate && python manage.py collectstatic -v 2 --noinput && python manage.py runserver --nostatic --noreload 0.0.0.0:3334'"]

    persistence:
      storage:
        enabled: true
        mountPath: /app/static_build/media/tsd-timelapses/private/
        type: nfs
        server: '${SAN_HOST}'
        path: /tank/k8s/apps/obico
      config:
        enabled: true
        mountPath: /app
        existingClaim: obico-config-v1

    sidecars:
      ml-api:
        name: ml-api
        image:
          repository: ghcr.io/gabe565/obico/ml-api
          tag: latest@sha256:24714a735a21511cd52ae7ae2698fb5f059bedc07992c7e3838f4130c4eb0c0e
        env:
          - name: FLASK_APP
            value: 'server.py'
        envFrom:
          # - secretRef:
          #     name: obico-secret
          - configMapRef:
              name: obico-configmap
        command: ["bash"]
        args:
          - -c
          - gunicorn
          - --bind 0.0.0.0:3333
          - --workers 1 wsgi
        service:
          main:
            ports:
              http:
                port: 3333
        volumeMounts:
          - name: config
            mountPath: /app
      tasks:
        name: tasks
        image:
          repository: ghcr.io/gabe565/obico/ml-api
          tag: latest@sha256:24714a735a21511cd52ae7ae2698fb5f059bedc07992c7e3838f4130c4eb0c0e
        envFrom:
          # - secretRef:
          #     name: obico-secret
          - configMapRef:
              name: obico-configmap
        command: ["sh", "-c celery", "-A config worker", "--beat", "-l info", "-c 2", "-Q realtime,celery"]
        volumeMounts:
          - name: config
            mountPath: /app
      redis:
        name: redis
        image: public.ecr.aws/docker/library/redis:7.0.9
        envFrom:
          # - secretRef:
          #     name: obico-secret
          - configMapRef:
              name: obico-configmap
        command: ['redis-server']
