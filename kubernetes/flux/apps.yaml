---
# yaml-language-server: $schema=https://kubernetes-schemas.kokoro.wtf/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cluster-apps
  namespace: flux-system
spec:
  interval: 10m
  path: ./kubernetes/apps
  prune: true
  sourceRef:
    kind: GitRepository
    name: k8s-home-ops
  postBuild:
    substituteFrom:
      - kind: ConfigMap
        name: cluster-settings
      - kind: Secret
        name: cluster-secrets
  patches:
    - patch: |-
        apiVersion: kustomize.toolkit.fluxcd.io/v1
        kind: Kustomization
        metadata:
          name: not-used
        spec:
          postBuild:
            substituteFrom:
              - kind: ConfigMap
                name: cluster-settings
              - kind: Secret
                name: cluster-secrets
      target:
        kind: Kustomization
        group: kustomize.toolkit.fluxcd.io
        labelSelector: substitution.flux.home.arpa/disabled notin (true)
    # - patch: |-
    #     apiVersion: helm.toolkit.fluxcd.io/v2beta1
    #     kind: HelmRelease
    #     metadata:
    #       name: not-used
    #     spec:
    #       values:
    #         ingress:
    #           main:
    #             annotations:
    #               nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    #   target:
    #     group: helm.toolkit.fluxcd.io
    #     version: v2beta1
    #     kind: HelmRelease
    #     labelSelector: ingress.home.arpa/type in (internal, external-auth)
    # - patch: |-
    #     apiVersion: helm.toolkit.fluxcd.io/v2beta1
    #     kind: HelmRelease
    #     metadata:
    #       name: not-used
    #     spec:
    #       values:
    #         ingress:
    #           main:
    #             annotations:
    #               nginx.ingress.kubernetes.io/auth-method: GET
    #               nginx.ingress.kubernetes.io/auth-url: http://authelia.security.svc.cluster.local:9091/api/verify
    #               nginx.ingress.kubernetes.io/auth-signin: https://auth.${EXTERNAL_DOMAIN}?rm=$request_method
    #               nginx.ingress.kubernetes.io/auth-response-headers: Remote-User,Remote-Name,Remote-Groups,Remote-Email
    #               nginx.ingress.kubernetes.io/auth-snippet: proxy_set_header X-Forwarded-Method $request_method;
    #   target:
    #     group: helm.toolkit.fluxcd.io
    #     version: v2beta1
    #     kind: HelmRelease
    #     labelSelector: ingress.home.arpa/type in (external-auth)
    # - patch: |-
    #     apiVersion: helm.toolkit.fluxcd.io/v2beta1
    #     kind: HelmRelease
    #     metadata:
    #       name: not-used
    #     spec:
    #       values:
    #         ingress:
    #           main:
    #             annotations:
    #               external-dns/is-public: "true"
    #               external-dns.alpha.kubernetes.io/target: "ingress.kokoro.wtf"
    #   target:
    #     group: helm.toolkit.fluxcd.io
    #     version: v2beta1
    #     kind: HelmRelease
    #     labelSelector: ingress.home.arpa/type in (external-auth, external)
