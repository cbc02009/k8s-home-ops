---
###
# A quick and dirty way to push custom Talos Linux build assets to your own GitHub repository.
#
# Note: This can most likely be optimized using caching and other mechanisms. I'm just more focused
#       on getting Talos v1.5.1 running right now and will look at this some more later-on.
###
name: Build and push Talos build assets

on:
  workflow_dispatch: { }

env:
  REGISTRY: ghcr.io

jobs:
  build-images:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
          - amd64
          - arm64
    container:
      image: ghcr.io/siderolabs/imager:v1.5.3
      options: --privileged
    steps:
      - name: Build installer w/ Nvidia extensions
        run: |
          /bin/imager installer \
            --arch ${{ matrix.arch }} \
            --system-extension-image ghcr.io/siderolabs/nonfree-kmod-nvidia:535.54.03-v1.5.1@sha256:f0b397d45322ddec3a6b9ee5ea8eca63425c92d253d28ec00686612b1df84baa \
            --system-extension-image ghcr.io/siderolabs/nvidia-container-toolkit:535.54.03-v1.13.5@sha256:e3fcc5727da6824cb39e50d828a7eee594f1a4f8956c5e44a73cfea2ff4ea83d \
            --system-extension-image ghcr.io/siderolabs/amd-ucode:20230804@sha256:5d01ef821a8dbb8581a87370c6a911bd4ef80e01b86345c4f00eef50776b3823

      - name: Upload artifacts
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 # v3
        with:
          name: talos-build-assets
          path: /out/*
          if-no-files-found: error
          retention-days: 1

  push-images:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
          - amd64
          - arm64
    needs:
      - build-images
    permissions:
      contents: read
      packages: write
    steps:
      - name: Download build asset images
        uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # v3
        with:
          name: talos-build-assets
          path: /tmp/talos-build-assets

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0
        with:
          version: v0.11.2
          driver-opts: image=moby/buildkit:v0.12.0
          # buildkitd-flags: --debug

      - name: Log in to the Container registry
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: imjasonh/setup-crane@00c9e93efa4e1138c9a7a5c594acd6c75a2fbf0c # v0.3
      - name: Crane push installer
        run: |
          crane push /tmp/talos-build-assets/metal-${{ matrix.arch }}-installer.tar ${{ env.REGISTRY }}/${{ github.repository }}/talos-metal-${{ matrix.arch }}-installer:v1.5.1
