---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: gitea-postgres-init
  annotations:
    policies.kyverno.io/title: Init database for gitea
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      This policy updates the postgres database for gitea
spec:
  mutateExistingOnPolicyUpdate: true
  generateExistingOnPolicyUpdate: true
  rules:
    - name: add-initdb-container
      match:
        all:
          - resources:
              kinds: [Pod]
              name: "gitea*"
      mutate:
        patchStrategicMerge:
          spec:
            initContainers:
              - name: init-postgres
                image: ghcr.io/onedr0p/postgres-initdb:14.5
                imagePullPolicy: IfNotPresent
                resources:
                  requests:
                    cpu: 10m
                    memory: 100Mi
                env:
                  - name: POSTGRES_HOST
                    value: postgres-rw.databases.svc.cluster.local
                  - name: POSTGRES_DB
                    value: gitea
                  - name: POSTGRES_SUPER_PASS
                    valueFrom:
                      secretKeyRef:
                        name: postgres-superuser
                        key: password
                envFrom:
                  - secretRef:
                      name: gitea-postgres
