---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mailu
  namespace: services
spec:
  interval: 5m
  chart:
    spec:
      chart: &app mailu
      version: 6.0.1
      sourceRef:
        kind: HelmRepository
        name: gitea-charts
        namespace: flux-system
      interval: 5m
  install:
    createNamespace: true
    remediation: # perform remediation when helm install fails
      retries: 5
  upgrade:
    remediation: # perform remediation when helm upgrade fails
      retries: 5
      remediateLastFailure: true # remediate the last failure, when no retries remain
    cleanupOnFail: true
  dependsOn:
    - name: postgres
      namespace: databases
  postRenderers:
    - kustomize:
        patchesStrategicMerge:
          - kind: StatefulSet
            apiVersion: apps/v1
            metadata:
              name: gitea
            spec:
              template:
                spec:
                  initContainers:
                    - name: init-db
                      image: ghcr.io/onedr0p/postgres-initdb:14.5
                      env:
                        - name: POSTGRES_HOST
                          value: postgres-rw.databases.svc.cluster.local
                        - name: POSTGRES_DB
                          value: gitea
                        - name: POSTGRES_SUPER_PASS
                          valueFrom:
                            secretKeyRef:
                              name: postgres-superuser
                              key: password
                      envFrom:
                        - secretRef:
                            name: gitea-postgres
