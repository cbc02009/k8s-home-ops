---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: maddy
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://k8s-at-home.com/charts/
      chart: maddy
      version: 3.1.2
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home-charts
        namespace: flux-system
      interval: 5m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5

  values:
    image:
      # -- image repository
      repository: angelnu/maddy
      tag: dev
      pullPolicy: Always

    maddy:
      hostname: "mx.${EXTERNAL_DOMAIN}"
      primary_domain: "${EXTERNAL_DOMAIN}"
      tls_secret_name: "${CLUSTER_CERT}"

      sql:
        type: postgres
        postgres_dsn:
          host: postgres-rw.databases.svc.cluster.local
          # -- The name of the DB
          # @default -- DB name set in embedded postgres chart
          dbname: TODO
          # -- The DB user
          # @default -- user set in embedded postgres chart
          user: TODO
          # -- The DB user password
          # @default -- user set in embedded postgres chart
          # password: < set in secret>
          # -- SSL model for the DB
          # disable - No SSL
          # require - Always SSL (skip verification)
          # verify-ca - Always SSL (verify that the certificate presented by the
          #             server was signed by a trusted CA)
          # verify-full - Always SSL (verify that the certification presented by
          #               the server was signed by a trusted CA and the server host name
          #               matches the one in the certificate)
          sslmode: require
